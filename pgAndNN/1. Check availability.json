{"createdAt":"2025-10-02T21:12:49.267Z","updatedAt":"2025-10-02T21:18:06.388Z","id":"nu0s5PPlcL6opJXy","name":"1. Check availability","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"d3e45ca0-e55e-44a8-83aa-ccad14cdea9b","name":"When Executed by Another Workflow"},{"parameters":{"operation":"executeQuery","query":"-- ШАГ 1: Проверка доступности задания\n-- Параметры: \n--   $1 - user_id\n--   $2 - task_id\n\nWITH task_info AS (\n    -- Получаем информацию о задании\n    SELECT \n        t.id,\n        t.title,\n        t.points,\n        t.system_name,\n        t.is_active,\n        t.is_one_time,\n        t.monthly_limit,\n        t.verification_type,\n        t.icon_url\n    FROM tasks t\n    WHERE t.id = $2\n),\nuser_stats AS (\n    -- Собираем статистику пользователя по этому заданию\n    SELECT \n        -- Проверка выполнения сегодня (для daily_bonus)\n        BOOL_OR(\n            DATE(completed_at) = CURRENT_DATE \n            AND status = 'approved'\n        ) as completed_today,\n        -- Проверка наличия задачи в работе (для manual заданий)\n        BOOL_OR(status = 'pending') as has_pending,\n        -- Количество выполнений за текущий месяц\n        COUNT(*) FILTER (\n            WHERE status = 'approved' \n            AND DATE_TRUNC('month', completed_at) = DATE_TRUNC('month', CURRENT_DATE)\n        ) as monthly_completed_count,\n        -- Проверка на выполнение одноразовых заданий\n        BOOL_OR(status = 'approved') as ever_completed\n    FROM user_tasks\n    WHERE user_id = $1 AND task_id = $2\n)\n-- Возвращаем результат проверки\nSELECT \n    jsonb_build_object(\n        'status', \n        CASE \n            -- Задание не найдено\n            WHEN ti.id IS NULL THEN false\n            -- Задание неактивно\n            WHEN ti.is_active = false THEN false\n            -- Ежедневный бонус уже получен сегодня\n            WHEN ti.system_name = 'daily_bonus' \n                 AND COALESCE(us.completed_today, false) = true THEN false\n            -- Одноразовое задание уже выполнено\n            WHEN ti.is_one_time = true \n                 AND COALESCE(us.ever_completed, false) = true THEN false\n            -- Месячный лимит исчерпан\n            WHEN ti.monthly_limit IS NOT NULL \n                 AND COALESCE(us.monthly_completed_count, 0) >= ti.monthly_limit THEN false\n            -- Задание с ручной проверкой уже находится в работе\n            WHEN ti.system_name IN ('cashback', 'instagram_subscribe', 'review', 'instagram_story') \n                 AND COALESCE(us.has_pending, false) = true THEN false\n            -- Доступно\n            ELSE true\n        END,\n        'message',\n        CASE \n            WHEN ti.id IS NULL THEN 'Задание не найдено'\n            WHEN ti.is_active = false THEN 'Задание неактивно'\n            WHEN ti.system_name = 'daily_bonus' \n                 AND COALESCE(us.completed_today, false) = true THEN 'Ежедневный бонус уже получен сегодня. Возвращайся завтра!'\n            WHEN ti.is_one_time = true \n                 AND COALESCE(us.ever_completed, false) = true THEN 'Вы уже выполнили это задание'\n            WHEN ti.monthly_limit IS NOT NULL \n                 AND COALESCE(us.monthly_completed_count, 0) >= ti.monthly_limit THEN 'Месячный лимит исчерпан'\n            WHEN ti.system_name IN ('cashback', 'instagram_subscribe', 'review', 'instagram_story') \n                 AND COALESCE(us.has_pending, false) = true THEN 'У вас уже есть заявка в работе'\n            ELSE 'Задание доступно'\n        END,\n        'task_info',\n        CASE \n            WHEN ti.id IS NOT NULL THEN\n                jsonb_build_object(\n                    'id', ti.id,\n                    'title', ti.title,\n                    'points', ti.points,\n                    'system_name', ti.system_name,\n                    'verification_type', ti.verification_type,\n                    'icon_url', ti.icon_url\n                )\n            ELSE NULL\n        END\n    ) as result\nFROM task_info ti\nLEFT JOIN user_stats us ON true;","options":{"queryReplacement":"={{ [ $json.user_id, $json.task_id ] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,0],"id":"682290d6-2614-400e-b765-d2790d105755","name":"Execute a SQL query","credentials":{"postgres":{"id":"IRbGwCxyepb2OPlB","name":"Postgres"}}}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"563930df-0ccc-4ffc-aa2d-01ee9587d6ff","triggerCount":0,"shared":[{"createdAt":"2025-10-02T21:12:49.267Z","updatedAt":"2025-10-02T21:12:49.267Z","role":"workflow:owner","workflowId":"nu0s5PPlcL6opJXy","projectId":"vI2eXglKNLswvn2H"}],"tags":[]}
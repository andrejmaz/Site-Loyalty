{"createdAt":"2025-10-02T21:34:48.277Z","updatedAt":"2025-10-02T21:48:45.706Z","id":"gRLogPVTZbdRjTKa","name":"3. Complete task (auto)","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"9581cccb-fc5e-45a5-aa21-fd090b8ce54a","name":"When Executed by Another Workflow"},{"parameters":{"operation":"executeQuery","query":"-- ШАГ 3: Завершение задачи (для verification_type = 'auto')\n-- Выполняет: обновление статуса, создание транзакции, обновление баланса\n-- Параметры: \n--   $1 - user_task_id (ID записи из user_tasks)\n\nWITH user_task_info AS (\n    SELECT \n        ut.id,\n        ut.user_id,\n        ut.task_id,\n        ut.points_awarded,\n        t.title,\n        t.system_name\n    FROM user_tasks ut\n    JOIN tasks t ON t.id = ut.task_id\n    WHERE ut.id = $1 AND ut.status = 'pending'\n),\nupdate_task AS (\n    UPDATE user_tasks \n    SET \n        status = 'approved',\n        completed_at = NOW(),\n        verified_at = NOW()\n    WHERE id = $1 AND status = 'pending'\n    RETURNING id\n),\nadd_transaction AS (\n    INSERT INTO point_transactions (\n        user_id,\n        amount,\n        transaction_type,\n        description,\n        task_id,\n        user_task_id,\n        created_at\n    )\n    SELECT \n        uti.user_id,\n        uti.points_awarded,\n        'task_reward',\n        uti.title,\n        uti.task_id,\n        uti.id,\n        NOW()\n    FROM user_task_info uti\n    WHERE EXISTS (SELECT 1 FROM update_task)\n    RETURNING id, amount\n),\nupdate_balance AS (\n    UPDATE users \n    SET card_balance = card_balance + (SELECT points_awarded FROM user_task_info)\n    WHERE id = (SELECT user_id FROM user_task_info)\n      AND EXISTS (SELECT 1 FROM update_task)\n    RETURNING id, card_balance\n)\n-- Используем VALUES для гарантированного возврата результата\nSELECT \n    COALESCE(\n        (SELECT jsonb_build_object(\n            'status', true,\n            'message', \n                CASE \n                    WHEN uti.system_name = 'daily_bonus' THEN 'Ежедневный бонус успешно получен!'\n                    WHEN uti.system_name = 'telegram_subscribe' THEN 'Спасибо за подписку! Бонус начислен'\n                    WHEN uti.system_name = 'referral' THEN 'Друг добавлен! Бонус начислен'\n                    ELSE 'Задание выполнено! Бонус начислен'\n                END,\n            'points_awarded', uti.points_awarded,\n            'new_balance', ub.card_balance\n        )\n        FROM update_task ut\n        CROSS JOIN user_task_info uti\n        LEFT JOIN update_balance ub ON true),\n        jsonb_build_object(\n            'status', false,\n            'message', 'Задание не найдено или уже выполнено',\n            'points_awarded', NULL,\n            'new_balance', NULL\n        )\n    ) as result;\n\n","options":{"queryReplacement":"={{ [ $json.user_task_id ] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,0],"id":"85229bc5-c8c1-4bfd-aeca-09a8aef523c4","name":"Execute a SQL query","alwaysOutputData":false,"credentials":{"postgres":{"id":"IRbGwCxyepb2OPlB","name":"Postgres"}}}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"user_task_id":43}}]},"versionId":"ea2c32ac-12bb-43dd-a6c6-1f4ae9630273","triggerCount":0,"shared":[{"createdAt":"2025-10-02T21:34:48.277Z","updatedAt":"2025-10-02T21:34:48.277Z","role":"workflow:owner","workflowId":"gRLogPVTZbdRjTKa","projectId":"vI2eXglKNLswvn2H"}],"tags":[]}
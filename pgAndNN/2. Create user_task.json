{"createdAt":"2025-10-02T21:18:21.722Z","updatedAt":"2025-10-03T21:25:27.422Z","id":"b4OBJxTVVkof1cTG","name":"2. Create user_task","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0],"id":"307debc0-2dc0-414a-b62e-4806cda18076","name":"When Executed by Another Workflow"},{"parameters":{"operation":"executeQuery","query":"-- ШАГ 2: Создание записи в user_tasks со статусом pending\n-- Параметры: \n--   $1 - user_id\n--   $2 - task_id\n--   $3 - points\n--   $4 - salebot_order_id\n\nWITH task_info AS (\n    SELECT points, title, verification_type\n    FROM tasks\n    WHERE id = $2 AND is_active = true\n),\ninsert_task AS (\n    INSERT INTO user_tasks (\n        user_id,\n        task_id,\n        status,\n        points_awarded,\n        completed_at,\n        verified_at,\n        salebot_order_id\n    )\n    SELECT \n        $1,\n        $2,\n        'pending',\n        COALESCE($3,ti.points),\n        NULL,  -- completed_at будет установлен при завершении\n        NULL,  -- verified_at будет установлен при завершении\n        NULLIF($4, 0)\n    FROM task_info ti\n    RETURNING id, user_id, task_id, status, points_awarded, created_at\n)\nSELECT \n    jsonb_build_object(\n        'status', true,\n        'message', 'Заявка создана',\n        'user_task', jsonb_build_object(\n            'id', it.id,\n            'user_id', it.user_id,\n            'task_id', it.task_id,\n            'status', it.status,\n            'points_awarded', it.points_awarded,\n            'created_at', it.created_at\n        ),\n        'verification_type', ti.verification_type\n    ) as result\nFROM insert_task it\nCROSS JOIN task_info ti;\n\n","options":{"queryReplacement":"={{ [ $json.user_id, $json.task_id, $json.points, $json.oder_id ] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,0],"id":"7e57356b-5c49-4432-8b80-617cd95e1788","name":"Execute a SQL query","credentials":{"postgres":{"id":"IRbGwCxyepb2OPlB","name":"Postgres"}}}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"user_id":20,"task_id":8,"points":null}}]},"versionId":"4f137e29-e1c9-4adf-9803-f52d18ad7ea0","triggerCount":0,"shared":[{"createdAt":"2025-10-02T21:18:21.722Z","updatedAt":"2025-10-02T21:18:21.722Z","role":"workflow:owner","workflowId":"b4OBJxTVVkof1cTG","projectId":"vI2eXglKNLswvn2H"}],"tags":[]}
# Flow выполнения заданий

Модульная система выполнения заданий с поддержкой автоматической и ручной проверки.

## Архитектура

```
┌─────────────────┐
│ 1. Проверка     │  ← Пользователь отправил задание
│    доступности  │
└────────┬────────┘
         │
         ▼ (если доступно)
┌─────────────────┐
│ 2. Создание     │  ← Создаём user_tasks (status = pending)
│    user_task    │
└────────┬────────┘
         │
         ├──────────────┬──────────────┐
         │              │              │
         ▼              ▼              │
  verification_type     │              │
         │              │              │
    ┌────┴─────┐        │              │
    │          │        │              │
   auto      manual     │              │
    │          │        │              │
    ▼          ▼        ▼              │
┌───────┐  ┌────────────────┐          │
│3. Авто│  │5. Создание     │          │
│завер. │  │   SaleBot CRM  │          │
└───┬───┘  └────────┬───────┘          │
    │               │                  │
    │               ▼                  │
    │      ┌────────────────┐          │
    │      │6. Уведомление  │          │
    │      │   менеджеру    │          │
    │      └────────┬───────┘          │
    │               │                  │
    │               ▼                  │
    │      ┌────────────────┐          │
    │      │7. Ожидание     │          │
    │      │   webhook      │          │
    │      └────────┬───────┘          │
    │               │                  │
    │          ┌────┴────┐             │
    │          │         │             │
    │          ▼         ▼             │
    │     ┌────────┐  ┌──────┐        │
    │     │Успех   │  │Отказ │        │
    │     │(4)     │  │(5b)  │        │
    │     └───┬────┘  └──┬───┘        │
    │         │          │             │
    └─────────┴──────────┴─────────────┘
              │
              ▼
        ┌──────────┐
        │ Ответ    │
        │ клиенту  │
        └──────────┘
```

---

## SQL-запросы

### 1️⃣ Проверка доступности задания
**Файл:** `1_check_availability.sql`

**Параметры:**
- `$1` - user_id
- `$2` - task_id

**Что проверяет:**
- ✅ Существование и активность задания
- ✅ Ежедневный бонус (получен ли сегодня)
- ✅ Одноразовые задания (выполнено ли)
- ✅ Месячный лимит
- ✅ Наличие заявки в работе (для manual заданий)

**Ответ:**
```json
{
  "status": true,
  "message": "Задание доступно",
  "task_info": {
    "id": 8,
    "title": "Ежедневный бонус",
    "points": 20,
    "system_name": "daily_bonus",
    "verification_type": "auto",
    "icon_url": "./images/icons/daily.svg"
  }
}
```

---

### 2️⃣ Создание записи в user_tasks
**Файл:** `2_create_user_task.sql`

**Параметры:**
- `$1` - user_id
- `$2` - task_id
- `$3` - salebot_order_id (опционально, по умолчанию 0)
- `$4` - comment (опционально, JSON с данными формы)

**Что делает:**
- Создаёт запись в `user_tasks` со статусом `pending`
- Возвращает информацию о созданной записи и `verification_type`

**Ответ:**
```json
{
  "status": true,
  "message": "Заявка создана",
  "user_task": {
    "id": 123,
    "user_id": 1,
    "task_id": 8,
    "status": "pending",
    "points_awarded": 20,
    "created_at": "2025-10-02T10:30:00Z"
  },
  "verification_type": "auto"
}
```

---

### 3️⃣ Завершение задачи (auto)
**Файл:** `3_complete_task_auto.sql`

**Параметры:**
- `$1` - user_task_id

**Что делает:**
1. Обновляет статус на `approved`
2. Создаёт транзакцию в `point_transactions`
3. Обновляет баланс пользователя

**Ответ:**
```json
{
  "status": true,
  "message": "Ежедневный бонус успешно получен!",
  "points_awarded": 20,
  "new_balance": 1540
}
```

---

### 4️⃣ Обработка успешного webhook
**Файл:** `4_webhook_success.sql`

**Параметры:**
- `$1` - user_task_id или salebot_order_id
- `$2` - тип поиска: `'id'` или `'salebot_order_id'`

**Что делает:**
1. Находит задание по ID или salebot_order_id
2. Обновляет статус на `approved`
3. Создаёт транзакцию
4. Обновляет баланс

**Ответ:**
```json
{
  "status": true,
  "message": "Задание проверено и одобрено! Бонус начислен",
  "user_id": 1,
  "user_name": "Андрей",
  "points_awarded": 50,
  "new_balance": 1590,
  "task_title": "Подписка на Instagram"
}
```

---

### 5️⃣ Обработка неуспешного webhook
**Файл:** `5_webhook_failure.sql`

**Параметры:**
- `$1` - user_task_id или salebot_order_id
- `$2` - тип поиска: `'id'` или `'salebot_order_id'`
- `$3` - причина отклонения (опционально)

**Что делает:**
1. Обновляет статус на `rejected`
2. Сохраняет причину отклонения в `comment`

**Ответ:**
```json
{
  "status": true,
  "message": "Заявка отклонена",
  "user_id": 1,
  "user_name": "Андрей",
  "task_title": "Подписка на Instagram",
  "rejection_reason": "Скриншот не подтверждает подписку"
}
```

---

## Примеры использования в N8N

### Пример 1: Ежедневный бонус (auto)

```
┌──────────────┐
│ Webhook      │ ← POST /api/tasks/execute
│ (триггер)    │   { user_id, task_id }
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 1. Проверка  │ ← SQL: 1_check_availability.sql
│ доступности  │   params: [user_id, task_id]
└──────┬───────┘
       │
       ▼ (if status = true)
┌──────────────┐
│ 2. Создание  │ ← SQL: 2_create_user_task.sql
│ user_task    │   params: [user_id, task_id, 0, null]
└──────┬───────┘
       │
       ▼ (if verification_type = 'auto')
┌──────────────┐
│ 3. Завершение│ ← SQL: 3_complete_task_auto.sql
│              │   params: [user_task_id]
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Ответ        │ → { status, message, points, balance }
└──────────────┘
```

### Пример 2: Подписка на Instagram (manual)

```
┌──────────────┐
│ Webhook      │ ← POST /api/tasks/execute
│ (триггер)    │   { user_id, task_id, screenshot }
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 1. Проверка  │ ← SQL: 1_check_availability.sql
│ доступности  │
└──────┬───────┘
       │
       ▼ (if status = true)
┌──────────────┐
│ 2. Создание  │ ← SQL: 2_create_user_task.sql
│ user_task    │   params: [user_id, task_id, salebot_id, JSON]
└──────┬───────┘
       │
       ▼ (if verification_type = 'manual')
┌──────────────┐
│ 5. SaleBot   │ ← Создание сделки в CRM
│ Create Deal  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 6. Уведомление│ ← Отправка в Telegram менеджеру
│ менеджеру    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Ответ клиенту│ → { status, message: "Заявка отправлена" }
└──────────────┘
       
       ... ОЖИДАНИЕ WEBHOOK ...
       
┌──────────────┐
│ Webhook      │ ← POST /api/tasks/webhook
│ от SaleBot   │   { order_id, status: "approved/rejected" }
└──────┬───────┘
       │
       ├─────────────┬──────────────┐
       │             │              │
       ▼             ▼              │
   approved      rejected           │
       │             │              │
┌──────────┐   ┌──────────┐        │
│4. Success│   │5. Failure│        │
└────┬─────┘   └────┬─────┘        │
     │              │              │
     └──────────────┴──────────────┘
                    │
                    ▼
           ┌────────────────┐
           │ Уведомление    │ ← Отправка в Telegram пользователю
           │ пользователю   │
           └────────────────┘
```

---

## Статусы заданий

| Статус | Описание |
|--------|----------|
| `pending` | Заявка создана, ожидает проверки |
| `approved` | Заявка одобрена, бонус начислен |
| `rejected` | Заявка отклонена |

---

## Типы проверки

| verification_type | Описание | Задания |
|-------------------|----------|---------|
| `auto` | Автоматическая проверка, сразу начисляется | daily_bonus, telegram_subscribe, referral |
| `manual` | Ручная проверка менеджером через SaleBot | cashback, instagram_subscribe, review, instagram_story |

---

## Важные замечания

1. **Транзакционность**: Все запросы используют CTE для атомарности операций
2. **Идемпотентность**: Повторное выполнение не приводит к дублированию
3. **Статусы**: Используем `pending` → `approved`/`rejected`
4. **Баланс**: Обновляется только при статусе `approved`
5. **salebot_order_id**: Используется для связи с CRM при manual verification

---

## Миграция со старого подхода

### Было (монолит):
```sql
-- Один большой запрос делал всё сразу
```

### Стало (модульно):
```sql
-- 1. Проверка
-- 2. Создание
-- 3. Обработка (auto/manual)
-- 4-5. Webhook (только для manual)
```

**Преимущества нового подхода:**
- ✅ Гибкость - легко добавлять новые типы заданий
- ✅ Отладка - понятно на каком этапе ошибка
- ✅ Повторное использование - одни запросы для разных заданий
- ✅ Масштабируемость - легко расширять функционал

